<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sentiment Prediction Tool</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/creativetimofficial/tailwind-starter-kit/compiled-tailwind.min.css" />
  <style>
    .fade-in {
      animation: fadeIn 0.8s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #09f;
      animation: spin 1s ease infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="text-gray-800 antialiased">
  <main class="min-h-screen bg-gray-100 py-10">
    <div class="container mx-auto px-4">
      <h1 class="text-4xl text-center font-bold mb-4">Sentiment Prediction Tool ðŸŽ¯</h1>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

        <!-- Left Side: Inputs -->
        <div class="bg-white p-6 rounded-lg shadow-md">
          <label class="block mb-2 font-semibold">Upload CSV File (with "text" column):</label>
          <input type="file" id="csvFileInput" accept=".csv" class="mb-4 w-full border p-2 rounded" />
          
          <label class="block mb-2 font-semibold">Or Enter Text Below:</label>
          <textarea id="textInput" rows="4" placeholder="e.g., I'm feeling great today!" class="w-full border p-2 rounded mb-4"></textarea>

          <button onclick="predict()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Predict</button>

          <div id="loadingSpinner" class="flex justify-center mt-4 hidden"><div class="spinner"></div></div>
        </div>

        <!-- Right Side: Result -->
        <div class="bg-white p-6 rounded-lg shadow-md">
          <h2 class="text-xl font-bold mb-2">Prediction Result</h2>
          <div id="predictionResult" class="min-h-[80px] mb-4 text-lg fade-in"></div>
          
          <button id="downloadBtn" style="display:none" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 mb-4">Download Predictions</button>

          <div>
            <canvas id="sentimentChart" class="mt-6"></canvas>
            <div id="sampleTable" class="mt-4 text-sm"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    function getEmoji(prediction) {
      const map = { "positive": "ðŸ˜Š", "negative": "ðŸ˜¡", "neutral": "ðŸ˜" };
      return map[prediction.toLowerCase()] || "";
    }

    function updateChart(results) {
      const ctx = document.getElementById("sentimentChart").getContext("2d");
      const counts = { positive: 0, negative: 0, neutral: 0 };
      results.forEach(r => counts[r.prediction]++);
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Positive', 'Negative', 'Neutral'],
          datasets: [{
            data: [counts.positive, counts.negative, counts.neutral],
            backgroundColor: ['#4ade80', '#f87171', '#60a5fa'],
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function showSampleTable(results) {
      const sample = results.slice(0, 5);
      const html = `
        <h3 class="text-md font-bold mb-1">Sample Predictions:</h3>
        <table class="w-full table-auto text-left border border-gray-200">
          <thead><tr><th class="px-2 py-1 border">Text</th><th class="px-2 py-1 border">Sentiment</th></tr></thead>
          <tbody>
            ${sample.map(row => `<tr><td class="border px-2 py-1">${row.text}</td><td class="border px-2 py-1">${row.prediction}</td></tr>`).join('')}
          </tbody>
        </table>`;
      document.getElementById("sampleTable").innerHTML = html;
    }

    function predict() {
      const fileInput = document.getElementById("csvFileInput");
      const textInput = document.getElementById("textInput");
      const resultDiv = document.getElementById("predictionResult");
      const spinner = document.getElementById("loadingSpinner");
      const downloadBtn = document.getElementById("downloadBtn");
      const sampleTable = document.getElementById("sampleTable");
      const chartCanvas = document.getElementById("sentimentChart");

      resultDiv.innerHTML = "";
      spinner.classList.remove("hidden");
      sampleTable.innerHTML = "";
      chartCanvas.replaceWith(chartCanvas.cloneNode(true));  // Reset chart

      if (fileInput.files.length > 0) {
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        fetch("http://localhost:5000/predict", {
          method: "POST",
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          const results = data.results;
          resultDiv.innerHTML = `<strong>${results.length}</strong> predictions made successfully! ðŸŽ‰`;
          downloadBtn.style.display = "block";
          showSampleTable(results);
          updateChart(results);

          // LocalStorage history
          const history = JSON.parse(localStorage.getItem("sentiment_history") || "[]");
          history.push({ time: new Date().toLocaleString(), count: results.length });
          localStorage.setItem("sentiment_history", JSON.stringify(history));

          // Download CSV
          downloadBtn.onclick = () => {
            const csv = "text,prediction\n" + results.map(r => `"${r.text.replace(/"/g, '""')}",${r.prediction}`).join("\n");
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "predictions.csv";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          };

          confetti({ particleCount: 100, spread: 70 });
        })
        .catch(err => resultDiv.innerHTML = `<span class="text-red-600">Error: ${err}</span>`)
        .finally(() => spinner.classList.add("hidden"));

      } else if (textInput.value.trim() !== "") {
        fetch("http://localhost:5000/predict", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: textInput.value.trim() })
        })
        .then(res => res.json())
        .then(data => {
          const emoji = getEmoji(data.prediction);
          resultDiv.innerHTML = `<strong>Prediction:</strong> ${data.prediction} ${emoji}`;
          resultDiv.classList.add("fade-in");
        })
        .catch(err => resultDiv.innerHTML = `<span class="text-red-600">Error: ${err}</span>`)
        .finally(() => spinner.classList.add("hidden"));
      } else {
        spinner.classList.add("hidden");
        resultDiv.innerHTML = `<span class="text-red-600">Please upload a file or enter text to predict.</span>`;
      }
    }
  </script>
</body>
</html>

